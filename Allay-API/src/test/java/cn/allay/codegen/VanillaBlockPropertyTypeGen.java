package cn.allay.codegen;

import cn.allay.utils.StringUtils;
import com.google.gson.JsonElement;
import com.google.gson.JsonParser;
import com.squareup.javapoet.*;
import lombok.SneakyThrows;

import javax.lang.model.element.Modifier;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Author: daoge_cmd <br>
 * Date: 2023/4/8 <br>
 * Allay Project <br>
 */
public class VanillaBlockPropertyTypeGen {

    private static final Path BLOCK_DATA_FILE_PATH = Path.of("Allay-API/src/test/resources/minecraft-bedrock-data.json");
    private static final Path FILE_OUTPUT_PATH_BASE = Path.of("Allay-API/src/main/java/cn/allay/block/property/vanilla");


    @SneakyThrows
    public static void main(String[] args) {
        var blockPropertyInfos = generateBlockPropertyInfos();
        for (BlockPropertyTypeInfo blockPropertyTypeInfo : blockPropertyInfos) {
            if (blockPropertyTypeInfo.type == BlockPropertyType.ENUM) {
                generateEnumClass(blockPropertyTypeInfo);
            }
        }
        //generate VanillaBlockProperties.java
        TypeSpec.Builder codeBuilder = TypeSpec.classBuilder("VanillaBlockPropertyTypes")
                .addJavadoc(
                        "Author: daoge_cmd <br>\n" +
                                "Automatically generated by {@link cn.allay.codegen.VanillaBlockPropertyTypeGen} <br>\n" +
                                "Allay Project <br>\n")
                .addModifiers(Modifier.PUBLIC, Modifier.FINAL)
                .addMethod(
                        MethodSpec.constructorBuilder()
                                .addModifiers(Modifier.PRIVATE)
                                .build());
        var enumPropertyClass = ClassName.get("cn.allay.block.property.type", "EnumPropertyType");
        var booleanPropertyClass = ClassName.get("cn.allay.block.property.type", "BooleanPropertyType");
        var intPropertyClass = ClassName.get("cn.allay.block.property.type", "IntPropertyType");
        for (BlockPropertyTypeInfo blockPropertyTypeInfo : blockPropertyInfos) {
            switch (blockPropertyTypeInfo.type) {
                case ENUM -> {
                    var enumClass = ClassName.get("cn.allay.block.property.vanilla.enums", blockPropertyTypeInfo.getEnumClassName());
                    codeBuilder.addField(
                            FieldSpec
                                    .builder(ParameterizedTypeName.get(enumPropertyClass, enumClass), blockPropertyTypeInfo.name.toUpperCase(), Modifier.PUBLIC, Modifier.FINAL, Modifier.STATIC)
                                    .initializer("$T.createType($S ,List.of($T.values()) ,$T.values()[0]).register()", enumPropertyClass, blockPropertyTypeInfo.name, enumClass, enumClass)
                                    .build()
                    );
                }
                case BOOLEAN -> {
                    codeBuilder.addField(
                            FieldSpec
                                    .builder(booleanPropertyClass, blockPropertyTypeInfo.name.toUpperCase(), Modifier.PUBLIC, Modifier.FINAL, Modifier.STATIC)
                                    .initializer("$T.createType($S, $N).register()", booleanPropertyClass, blockPropertyTypeInfo.name, blockPropertyTypeInfo.validValues.get(0))
                                    .build()
                    );
                }
                case INTEGER -> {
                    int min = Integer.MAX_VALUE;
                    int max = Integer.MIN_VALUE;
                    for (var value : blockPropertyTypeInfo.validValues) {
                        var intValue = Integer.parseInt(value);
                        if (intValue < min) {
                            min = intValue;
                        }
                        if (intValue > max) {
                            max = intValue;
                        }
                    }
                    codeBuilder.addField(
                            FieldSpec
                                    .builder(intPropertyClass, blockPropertyTypeInfo.name.toUpperCase(), Modifier.PUBLIC, Modifier.FINAL, Modifier.STATIC)
                                    .initializer("$T.createType($S, $L, $L, $L).register()", intPropertyClass, blockPropertyTypeInfo.name, min, max, blockPropertyTypeInfo.validValues.get(0))
                                    .build()
                    );
                }
            }
        }
        var propertyClass = ClassName.get("cn.allay.block.property.type", "BlockPropertyType");
        var listClass = ParameterizedTypeName.get(ClassName.get("java.util", "List"), ParameterizedTypeName.get(propertyClass, WildcardTypeName.subtypeOf(Object.class)));
        String paramStr = blockPropertyInfos.stream().map(info -> info.name.toUpperCase()).collect(Collectors.joining(", "));
        codeBuilder.addField(
                FieldSpec
                        .builder(listClass, "VALUES", Modifier.PUBLIC, Modifier.FINAL, Modifier.STATIC)
                        .initializer("List.of($N)", paramStr)
                        .build()
        );
        codeBuilder.addMethod(
                MethodSpec
                        .methodBuilder("values")
                        .returns(listClass)
                        .addStatement("return VALUES")
                        .addModifiers(Modifier.STATIC, Modifier.PUBLIC)
                        .build()
        );
        var javaFile = JavaFile.builder("cn.allay.block.property.vanilla", codeBuilder.build()).build();
        Files.writeString(FILE_OUTPUT_PATH_BASE.resolve("VanillaBlockPropertyTypes.java"), javaFile.toString());
    }

    @SneakyThrows
    protected static void generateEnumClass(BlockPropertyTypeInfo info) {
        var enumName = info.getEnumClassName();
        TypeSpec.Builder codeBuilder = TypeSpec.enumBuilder(enumName)
                .addJavadoc(
                        "Author: daoge_cmd <br>\n" +
                                "Automatically generated by {@link cn.allay.codegen.VanillaBlockPropertyTypeGen} <br>\n" +
                                "Allay Project <br>\n")
                .addModifiers(Modifier.PUBLIC);
        for (var value : info.validValues) {
            codeBuilder.addEnumConstant(value.toUpperCase());
        }
        var javaFile = JavaFile.builder("cn.allay.block.property.vanilla.enums", codeBuilder.build()).build();
        var path = FILE_OUTPUT_PATH_BASE.resolve("enums/" + enumName + ".java");
        if (Files.exists(path))
            Files.delete(path);
        Files.writeString(path, javaFile.toString());
    }

    @SneakyThrows
    protected static List<BlockPropertyTypeInfo> generateBlockPropertyInfos() {
        try (var reader = Files.newBufferedReader(BLOCK_DATA_FILE_PATH)) {
            return JsonParser
                    .parseReader(reader)
                    .getAsJsonObject()
                    .getAsJsonObject("blockProperties")
                    .asMap()
                    .entrySet()
                    .stream()
                    .map(entry -> {
                        var propertyName = entry.getKey();
                        var validValues = entry.getValue().getAsJsonArray().get(0).getAsJsonObject().getAsJsonArray("validValues").asList().stream().map(JsonElement::getAsString).toList();
                        var propertyType = getPropertyType(validValues.get(0));
                        return new BlockPropertyTypeInfo(propertyName, validValues, propertyType);
                    }).toList();
        }
    }

    protected static BlockPropertyType getPropertyType(String value) {
        if (value.equals("true") || value.equals("false")) {
            return BlockPropertyType.BOOLEAN;
        }
        try {
            Integer.parseInt(value);
            return BlockPropertyType.INTEGER;
        } catch (NumberFormatException ignore) {
        }
        return BlockPropertyType.ENUM;
    }

    protected static String convertToCamelCase(String str) {
        List<String> parts = StringUtils.fastSplit(str, "_");
        StringBuilder output = new StringBuilder();

        for (String part : parts) {
            output.append(Character.toUpperCase(part.charAt(0)));
            output.append(part.substring(1));
        }

        return output.toString();
    }

    protected enum BlockPropertyType {
        BOOLEAN,
        INTEGER,
        ENUM
    }

    protected record BlockPropertyTypeInfo(String name, List<String> validValues, BlockPropertyType type) {
        public String getEnumClassName() {
            return convertToCamelCase(name);
        }
    }
}
