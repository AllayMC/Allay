package org.allaymc.codegen;

import com.google.gson.JsonParser;
import com.squareup.javapoet.*;
import lombok.SneakyThrows;
import org.allaymc.dependence.StringUtils;

import javax.lang.model.element.Modifier;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

/**
 * Allay Project 2024/6/11
 *
 * @author daoge_cmd
 */
public class VanillaMaterialTypeGen {
    static final Path MATERIAL_DATA_FILE_PATH = Path.of(CodeGen.DATA_PATH + "materials.json");
    static final ClassName MATERIAL_TYPE_CLASS = ClassName.get("org.allaymc.api.block.material", "MaterialType");
    static final Set<String> KEYS = new HashSet<>();
    static final String JAVA_DOC = """
            Automatically generated by {@code org.allaymc.codegen.VanillaMaterialTypeGen} <br>
            Allay Project <p>
            @author daoge_cmd
            """;

    static {
        try (var reader = new InputStreamReader(Files.newInputStream(MATERIAL_DATA_FILE_PATH))) {
            JsonParser.parseReader(reader).getAsJsonObject().entrySet().forEach(entry -> KEYS.add(entry.getKey()));
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    public static void main(String[] args) {
        generate();
    }

    @SneakyThrows
    public static void generate() {
        TypeSpec.Builder codeBuilder = TypeSpec.interfaceBuilder("VanillaMaterialTypes")
                .addJavadoc(JAVA_DOC)
                .addModifiers(Modifier.PUBLIC)
                .addField(
                        FieldSpec
                                .builder(ParameterizedTypeName.get(ClassName.get(Map.class), ClassName.get(String.class), MATERIAL_TYPE_CLASS), "NAME_TO_MATERIAL_TYPE", Modifier.PUBLIC, Modifier.STATIC, Modifier.FINAL)
                                .initializer("new $T<>()", HashMap.class)
                                .build()
                )
                .addMethod(
                        MethodSpec
                                .methodBuilder("create")
                                .addModifiers(Modifier.PUBLIC, Modifier.STATIC)
                                .returns(MATERIAL_TYPE_CLASS)
                                .addParameter(String.class, "name")
                                .addStatement("var tag = new $T(name)", MATERIAL_TYPE_CLASS)
                                .addStatement("NAME_TO_MATERIAL_TYPE.put(name, tag)")
                                .addStatement("return tag")
                                .build()
                )
                .addMethod(
                        MethodSpec
                                .methodBuilder("getMaterialTypeByName")
                                .addModifiers(Modifier.PUBLIC, Modifier.STATIC)
                                .returns(MATERIAL_TYPE_CLASS)
                                .addParameter(String.class, "name")
                                .addStatement("return NAME_TO_MATERIAL_TYPE.get(name)")
                                .build()
                );
        for (var key : KEYS) {
            var fieldName = StringUtils.fastTwoPartSplit(key, ":", "")[1].toUpperCase();
            codeBuilder.addField(
                    FieldSpec
                            .builder(MATERIAL_TYPE_CLASS, fieldName)
                            .addModifiers(Modifier.PUBLIC, Modifier.STATIC, Modifier.FINAL)
                            .initializer("create($S)", key)
                            .build()
            );
        }

        var javaFile = JavaFile.builder("org.allaymc.api.data", codeBuilder.build())
                .indent("   ")
                .build();
        Files.writeString(Path.of("Allay-API/src/main/java/org/allaymc/api/data/VanillaMaterialTypes.java"), javaFile.toString());
    }
}
